# IPFS模块解析

在IPFS的诸多特性里，很多重要特性都是由3个工程模块库集成而来的，这3个组件分别是Multiformat（自描述格式协议库）、libp2p（P2P网络协议模块库）和IPLD（数据结构模型库），它们被设计为轻耦合的堆栈模型，模块之间互相协同，也能保证一定的独立性。

## Multi-Format

Multi-Format是IPFS内的**自描述格式**协议组件，它是为了解决各种编程语言或数据类型难以详细区分而诞生的，其可以提高数据的可读性，并且能长期适应今后的开发趋势。它的方法是在数据上添加自描述的字段，那么只需要在字段上判断数据的属性即可。

对于一个自描述协议，Multi-Formats是怎么给出定义的呢？我们主要从3个方面考虑。

1) 一个自描述文件或者变量，必须在它的值内描述自己，不能从函数、外带参数、文档甚至是隐式信息中体现。
2) 考虑到效率，自描述协议必须保持数据的紧凑性。
3) 自描述协议要有可读性。

在这一节，我们主要为大家介绍各类Multi-Formats的形式定义。与其他组件相比，它的实现相对简单。

### Multi-Hash

Multi-Hash实现了自描述**哈希协议**。

#### Multi-Hash格式

Multi-Hash的格式存有3类信息，分别是类型type、长度length和哈希值value。格式命名为模式（type-length-value）。3类信息连接在一起的值就是Multi-Hash。

```sh
<Multi-Hash> ::= <type-哈希函数类型><length-长度><hash_value-哈希值>
```

* type是无符号整型数，用于描述哈希函数类型。具体可以在Multi-Hash映射表查询与函数类型对应的type。
* length也是一个无符号整型数，用于描述这一摘要的字节长度。
* value就是哈希值本身，其长度是length个字节。

Multi-Hash只会在原有的哈希值长度下增加2字节，用于描述它的长度和哈希函数类型。使用Multi-Hash编码的哈希，可以带来诸多好处。

1) 拿到一个哈希值，直接通过阅读这个值的前两字节就能判断出它的加密方式。
2) 更新系统的加密算法，使用Multi-Hash封装可以为以后升级带来便利。
3) 不占用太多额外的空间。

### Multi-Base

Multi-Base是**自描述基础编码协议**，用于保存数据并描述该数据是如何编码的。Multi-Base可以自由选择输入和输出的编码类型。因为Multi-Base是自描述的，其他程序也能通过该值获取到其编码类型，这样能减少开发代码的复杂度。

#### Multi-Base格式

Multi-Base的格式存有两类信息，分别是编码代号type和编码数据value。此处不再需要给出长度了，并且只需要1字节来区分各种类型，
因为常见的基础编码方式并不多。

```sh
<Multi-Base> ::= <type-编码类型><value-编码内容>
```

* type是由8位编码的无符号整型数组成的，用于描述编码类型。
* value是编码内容。

### Multi-Addr

Multi-Addr与前几类类似，我们在搭建应用时，对地址也需要额外的代码来详细解释。例如，我们需要说明一个地址究竟是IPv4地址还是IPv6地址？是TCP协议还是UDP协议？而Multi-Addr组建就是为了把自描述的信息添加在地址数据中。Multi-Addr分为两个版本，一类为具有可读性的UTF-8编码的版本，用于向用户展示；一类是十六进制版本，方便网络传输。

#### Multi-Addr格式

Multi-Addr的格式也有两类信息，分别是地址类型代号type和编码数据value，每个Multi-Addr都由type/value形式循环表示，形如：/地址类型代号/地址/地址类型代号/地址。

```sh
<UTF-8 Multi-Address> ::= /<UTF-8 type-地址类型>/<UTF-8地址>
<机读Multi-Address> ::= /<十六进制 type-地址类型>/<十六进制地址>
```

### Multi-Codec

Multi-Codec就是为了使得数据更加紧凑地自描述的编码解码器。其整体思路与前几个Multi-Formats相同。除了定义了Multi-Hash、Multi-Addr、Multi-Base等数据类型以外，Multi-Codec还定义了JSON文件类型、压缩类型、图片类型及IPLD。考虑到今后IPFS可能作为多种区块链的存储方案，Multi-Codec同样将目前主流区块链的交易和区块加入其中。Multi-Codec定义形式与前面提到的3种类似，为Multi-Codectype+编码数据。

```sh
<Multi-Codec> ::= /<十六进制 type >/<数据内容>
```

### Multi-Stream
Multi-Stream是自描述编码流协议，用于实现自描述的位串，其主要场景是在网络中传输。在进行过Multi-Stream编码后，编码流能实现自我描述的功能。
Multi-Stream包含3个字段，分别为流长度、Multi-Codec类型和编码数据本身，之间使用两个分隔符分隔开。其定义如下所示：

```sh
<Multi-Codec> ::= <流长度length>/<Multi-Codec type>\n<编码数据>
```

## libp2p

libp2p负责IPFS数据的网络通信、路由、交换等功能。

### libp2p的功能

libp2p能帮助你连接各个设备节点的网络通信库，即：任意两个节点，不管在哪里，不管处于什么环境，不管运行什么操作系统，不管是不是在NAT之后，只要它们有物理上连接的可能性，那么libp2p就会帮你完成这个连接。同时，libp2p还是一个工具库。我们平常在做软件开发的时候，不仅要关注底层（例如：TCP连接），还需要关注连接状态等信息。libp2p抽象集成了所有开发者基本都需要的一些工具属性功能，这些工具的功能主要包括：节点之间的链接复用；节点信息之间的互相交换；指定中继节点；网络地址转换（NAT）；分布式哈希表（dht）寻址；消息往返时延（RTT）统计等。

对于整个IPFS协议来说，libp2p处于非常重要的一个模块，这是因为在研发IPFS的时候，遇到了大量的异构设备，这些设备上运行着不同的操作系统，硬件和网络环境非常复杂。比如在我国的网络环境下，需要多种NAT穿越；还有某些场景下，可能用不了TCP连接，同时也存在协议变迁的情况。因此，协议实验室需要为IPFS和Filecoin打造一个健壮的网络层软件设施。大家如果对IPFS的源码有过研究，就会发现IPFS的很多功能就是对libp2p的一个简单抽象与包装。换句话说，如果你有
一些新的想法，完全可以基于libp2p库实现一个新的IPFS或者其他分布式系统。

### libp2p核心原理


## IPLD

